name: Iniciar Live com Cache e Cria√ß√£o Autom√°tica do package.json

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID do v√≠deo'
        required: true
      stream_url:
        description: 'URL do stream (RTMP, ex: Facebook Live)'
        required: true
      chave_json:
        description: 'Conte√∫do do arquivo chave.json para autentica√ß√£o Google Drive'
        required: true

jobs:
  run-live:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Clonar reposit√≥rio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Criar package.json automaticamente
        run: |
          echo '{
            "name": "live-stream",
            "version": "1.0.0",
            "dependencies": {
              "axios": "^1.4.0",
              "fs-extra": "^11.1.1",
              "puppeteer": "^21.3.8"
            }
          }' > package.json

      - name: üì¶ Cache do npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-cache-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-cache-

      - name: üì• Instalar depend√™ncias
        run: npm install

      - name: üõ†Ô∏è Instalar ffmpeg
        run: sudo apt update && sudo apt install -y ffmpeg

      - name: üßæ Criar arquivo input.json
        run: |
          echo '{
            "id": "${{ github.event.inputs.id }}",
            "stream_url": "${{ github.event.inputs.stream_url }}",
            "chave_json": ${{ toJson(github.event.inputs.chave_json) }}
          }' > input.json

      - name: ‚ñ∂Ô∏è Executar live.js
        run: node live.js input.json

      - name: ‚úÖ Upload do v√≠deo original (para depura√ß√£o)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ github.event.inputs.id }}
          path: ${{ github.event.inputs.id }}.mp4
