name: Live Automation

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID do vídeo'
        required: true
        type: string
      video_url:
        description: 'URL do vídeo para download'
        required: true
        type: string
      stream_url:
        description: 'URL do stream Facebook'
        required: true
        type: string

jobs:
  run-live:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache npm modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Create package.json if missing (only Puppeteer)
        run: |
          if [ ! -f package.json ]; then
            echo '{
              "name": "live-automation",
              "version": "1.0.0",
              "main": "live.js",
              "dependencies": {
                "puppeteer": "^20.7.4"
              }
            }' > package.json
          fi

      - name: Install dependencies
        run: npm install

      - name: Create input JSON file
        run: |
          echo '{
            "id": "${{ github.event.inputs.id }}",
            "video_url": "${{ github.event.inputs.video_url }}",
            "stream_url": "${{ github.event.inputs.stream_url }}"
          }' > input.json

      - name: Run live.js script from repo root
        run: node live.js input.json
