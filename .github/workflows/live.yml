name: Montar v√≠deo com logo, rodap√© e partes

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID do evento/live'
        required: true
        type: string

      video_principal:
        description: 'ID do v√≠deo principal no Google Drive'
        required: true
        type: string

      rodape_base64:
        description: 'Imagem base64 do rodap√© (PNG)'
        required: false
        type: string

      rodape_texto:
        description: 'Texto que ser√° exibido ao lado do rodap√©'
        required: false
        type: string

      videos_extras:
        description: 'IDs dos v√≠deos extras separados por v√≠rgula (m√°x. 5)'
        required: false
        type: string

      stream_url:
        description: 'URL para onde ser√° enviado o v√≠deo final (RTMP ou outro)'
        required: false
        type: string

      chave_json:
        description: 'Conte√∫do da chave JSON do Google Drive'
        required: true
        type: string

jobs:
  montar-video:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Clonar reposit√≥rio
        uses: actions/checkout@v4

      - name: üì¶ Instalar depend√™ncias
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          echo '{}' > package.json
          npm install googleapis puppeteer

      - name: üìÑ Gerar input.json a partir do segredo e inputs
        run: |
          echo '${{ secrets.SACREDI_JSON }}' > sacredi.json
          echo '${{ inputs.chave_json }}' > chave.json

          RODAPE_EXTRAS=$(echo "${{ inputs.videos_extras }}" | awk -F',' '{for(i=1;i<=NF;i++) printf "\"%s\"%s", $i, (i<NF?",":"") }')

          jq -n \
            --arg id "${{ inputs.id }}" \
            --arg video_principal "${{ inputs.video_principal }}" \
            --arg rodape_base64 "${{ inputs.rodape_base64 }}" \
            --arg rodape_texto "${{ inputs.rodape_texto }}" \
            --arg stream_url "${{ inputs.stream_url }}" \
            --argjson extras "[$RODAPE_EXTRAS]" \
            --slurpfile sacredi sacredi.json \
          '{
            id: $id,
            video_principal: $video_principal,
            video_inicial: $sacredi[0].video_inicial,
            video_miraplay: $sacredi[0].video_miraplay,
            video_final: $sacredi[0].video_final,
            logo_id: $sacredi[0].logo_id,
            rodape_base64: $rodape_base64,
            rodape_texto: $rodape_texto,
            videos_extras: $extras,
            stream_url: $stream_url
          }' > input.json

      - name: üß† Executar script de montagem
        run: node unir.js

      - name: üì§ Upload do v√≠deo final
        uses: actions/upload-artifact@v4
        with:
          name: video_final
          path: video_final_completo.mp4

  transmitir-video:
    runs-on: ubuntu-latest
    needs: montar-video

    steps:
      - name: üì• Clonar reposit√≥rio
        uses: actions/checkout@v4

      - name: üì¶ Instalar depend√™ncias para transmiss√£o
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          echo '{}' > package.json
          npm install puppeteer

      - name: üìÑ Copiar v√≠deo final e stream_info.json do job anterior
        uses: actions/download-artifact@v3
        with:
          name: video_final
          path: .

      - name: ‚ñ∂Ô∏è Transmitir v√≠deo final
        env:
          SERVER_STATUS_URL: ${{ secrets.SERVER_STATUS_URL }}
        run: node transmitir.js
