name: Live Stream Workflow

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID único do vídeo'
        required: true
      video_drive_id:
        description: 'ID do vídeo principal no Google Drive'
        required: true
      stream_url:
        description: 'URL do stream RTMP (Facebook, YouTube, etc.)'
        required: true
      chave_json:
        description: 'Conteúdo da chave JSON para autenticação Google Drive'
        required: true
      logo_id:
        description: 'ID da imagem do logo no Google Drive'
        required: false
      video_extra_1:
        description: 'ID vídeo extra 1 no Drive'
        required: false
      video_extra_2:
        description: 'ID vídeo extra 2 no Drive'
        required: false
      video_extra_3:
        description: 'ID vídeo extra 3 no Drive'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Prepare working directory
      run: |
        mkdir -p stream
        mkdir -p resposta

    - name: Save chave.json
      run: echo '${{ inputs.chave_json }}' > chave.json

    - name: Create input.json
      run: |
        cat <<EOF > input.json
        {
          "id": "${{ inputs.id }}",
          "video_principal": "${{ inputs.video_drive_id }}",
          "videos_opcionais": [
            "${{ inputs.video_extra_1 }}",
            "${{ inputs.video_extra_2 }}",
            "${{ inputs.video_extra_3 }}"
          ].filter(Boolean),
          "logo_id": "${{ inputs.logo_id }}",
          "stream_url": "${{ inputs.stream_url }}"
        }
        EOF

    - name: Install dependencies
      run: npm install googleapis puppeteer

    - name: Run unir.js to download and prepare videos
      run: node unir.js
      env:
        KEYFILE: chave.json
        INPUTFILE: input.json

    - name: Run live.js to start live streaming
      run: node live.js

