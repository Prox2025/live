name: Iniciar Live com Cache e CriaÃ§Ã£o AutomÃ¡tica do package.json

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'Nome do vÃ­deo (ex: a2c438366d)'
        required: true
      video_drive_id:
        description: 'ID real do vÃ­deo no Google Drive'
        required: true
      stream_url:
        description: 'URL do stream (RTMP, ex: Facebook Live)'
        required: true
      chave_json:
        description: 'ConteÃºdo do arquivo chave.json para autenticaÃ§Ã£o Google Drive'
        required: true
      logo_id:
        description: 'ID da imagem logo.png no Google Drive'
        required: false
      video_extra_1:
        description: 'ID do vÃ­deo extra 1'
        required: false
      video_extra_2:
        description: 'ID do vÃ­deo extra 2'
        required: false
      video_extra_3:
        description: 'ID do vÃ­deo extra 3'
        required: false

jobs:
  run-live:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Criar package.json automaticamente
        run: |
          echo '{
            "name": "live-stream",
            "version": "1.0.0",
            "dependencies": {
              "puppeteer": "^21.3.8",
              "googleapis": "^118.0.0",
              "fluent-ffmpeg": "^2.1.2",
              "get-video-duration": "^4.0.0"
            }
          }' > package.json

      - name: ğŸ“¦ Cache do npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-cache-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-cache-

      - name: ğŸ“¥ Instalar dependÃªncias
        run: npm install

      - name: ğŸ› ï¸ Instalar ffmpeg
        run: sudo apt update && sudo apt install -y ffmpeg

      - name: ğŸ“„ Criar input.json
        run: |
          echo "{
            \"id\": \"${{ github.event.inputs.id }}\",
            \"video_drive_id\": \"${{ github.event.inputs.video_drive_id }}\",
            \"stream_url\": \"${{ github.event.inputs.stream_url }}\",
            \"chave_json\": ${{ toJson(github.event.inputs.chave_json) }},
            \"logo_id\": \"${{ github.event.inputs.logo_id || '' }}\",
            \"video_extra_1\": \"${{ github.event.inputs.video_extra_1 || '' }}\",
            \"video_extra_2\": \"${{ github.event.inputs.video_extra_2 || '' }}\",
            \"video_extra_3\": \"${{ github.event.inputs.video_extra_3 || '' }}\"
          }" > input.json

      - name: ğŸ§¾ Mostrar conteÃºdo do input.json
        run: cat input.json

      - name: â–¶ï¸ Executar live.js
        run: node live.js input.json

      - name: ğŸ“¤ Upload do vÃ­deo original (para depuraÃ§Ã£o)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ github.event.inputs.id }}
          path: final_${{ github.event.inputs.id }}.mp4
