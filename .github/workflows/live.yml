name: Montar vÃ­deo com logo, rodapÃ© e partes

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID do evento/live'
        required: true
        type: string

      video_principal:
        description: 'ID do vÃ­deo principal no Google Drive'
        required: true
        type: string

      rodape_base64:
        description: 'Imagem base64 do rodapÃ© (PNG)'
        required: false
        type: string

      rodape_texto:
        description: 'Texto que serÃ¡ exibido ao lado do rodapÃ©'
        required: false
        type: string

      videos_extras:
        description: 'IDs dos vÃ­deos extras separados por vÃ­rgula (mÃ¡x. 5)'
        required: false
        type: string

      stream_url:
        description: 'URL para onde serÃ¡ enviado o vÃ­deo final (RTMP ou outro)'
        required: false
        type: string

jobs:
  montar-video:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          npm install

      - name: ðŸ“„ Gerar input.json a partir do segredo e inputs
        run: |
          echo '${{ secrets.SACREDI_JSON }}' > sacredi.json
          jq -n --arg id "${{ inputs.id }}" \
                --arg video_principal "${{ inputs.video_principal }}" \
                --arg rodape_base64 "${{ inputs.rodape_base64 }}" \
                --arg rodape_texto "${{ inputs.rodape_texto }}" \
                --arg stream_url "${{ inputs.stream_url }}" \
                --arg videos_extras "${{ inputs.videos_extras }}" \
                --slurpfile sacredi sacredi.json \
            '{
              id: $id,
              video_principal: $video_principal,
              video_inicial: $sacredi[0].video_inicial,
              video_miraplay: $sacredi[0].video_miraplay,
              video_final: $sacredi[0].video_final,
              logo_id: $sacredi[0].logo_id,
              rodape_base64: $rodape_base64,
              rodape_texto: $rodape_texto,
              videos_extras: (if $videos_extras == "" then [] else ($videos_extras | split(",") | map(.) ) end),
              stream_url: $stream_url
            }' > input.json

      - name: ðŸ”‘ Adicionar chave do Google Drive
        run: echo "${{ secrets.GDRIVE_KEY }}" > chave.json

      - name: ðŸ§  Executar script de montagem
        run: node unir.js

      - name: ðŸ“¤ Upload do vÃ­deo final (opcional)
        uses: actions/upload-artifact@v3
        with:
          name: video_final
          path: video_final_completo.mp4
